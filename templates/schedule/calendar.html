{% extends "common/base.html"%}
{% load static %}
{% block page_title %}
カレンダー{{calendar.name}}
{% endblock %}

{% block extra_head %}
  <!-- fullcalendar -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/locales-all.global.min.js"></script>
  <script src="{% static 'schedule/js/script.js' %}"></script>

  <!-- flatpckr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
      
  <!--日本語化用JS-->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
  
  <!-- fontawesome -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/js/all.min.js"></script>
  <link rel="stylesheet" src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <script src="{% static 'schedule/js/add_permission.js' %}"></script>
  <script src="{% static 'schedule/js/permission_edit.js' %}"></script>
  
  <script> 
    //　特殊文字("<",">","'",etc...)をエスケープしないための処理
    {% autoescape off %}
      let events = {{ events }}
      let edit_event = "{% url 'schedule:calendar' 0%}"
      let delete_event = "{% url 'schedule:delete_event' 0%}"
    {% endautoescape %} 
  </script>
{% endblock  %}

{% block header %}
  {% if  calendars %}
    {% include 'schedule/permission_edit.html' %}
  {% endif %}
{% endblock %}


{% block extra_navbar %}
  <li class="nav-item mb-2">
    <div class="text-center text-white">
      <h5>カレンダー一覧</h5>
    </div>
    {% for calendar in calendars %}
    <div class="d-flex justify-content-center">
        <a class="text-white" href="{% url 'schedule:calendar' calendar.id %}">{{ calendar.name }}</a>
    </div>
    {% endfor %}  
  </li>
  <hr style="height:2px; background-color:white;">
  <li class="nav-item mb-2" >
      <div class="d-flex justify-content-center">
          <button type="button" id="create" class="btn text-white p-0 m-0" data-bs-toggle="modal" data-bs-target="#createcalendarBackdrop">
              <h5 class="mb-0">カレンダー新規作成</h5>
          </button>
          <div class="modal" id="createcalendarBackdrop" data-bs-backdrop="static" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">新規作成フォーム</h5>
                  <!-- modal終了のボタン -->
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form action="{% url 'schedule:createcalendar' %}" method="post" id="create_calendar">
                      {% csrf_token %}
                      <input class="mb-2" type="text" name="name" placeholder="カレンダー名">
                  
                      {# TODO: メールアドレスを指定、ユーザーを選び、そのユーザーに対する権限を指定する。#} 
                      
                      {% comment %}
                      ユーザーの指定方法1: Ajaxを使ってメールアドレスを入力、サーバー側にユーザー検索をしてもらい、ヒットしたユーザーを選択する。(難しい)
                      ユーザーの指定方法2: メールアドレスを入力。カレンダー作成のフォームを投稿する。ビュー側でメールアドレスを元にuserを指定する。
                      {% endcomment %}
                  
                      {# TODO:この一人分の権限のフォームはJavaScriptで増やせるようにする。 #} 
                      <div id="permission_form_area">
                          <input class="btn btn-info" id="permission_form_add" type="button" value="権限追加">
                      </div>
                  </form>
                </div>
                <div class="modal-footer">
                       <button type="submit" class="btn btn-primary" form="create_calendar">新規作成</button>
                </div>
              </div>
            </div>
          </div>
      </div>
  </li>
  <li class="nav-item">
    <form class="d-flex justify-content-center mb-2 logout" method="post" action="{% url 'account_logout' %}" aria-current="page">
        {% csrf_token %}
        {% if redirect_field_value %}
            <input type="hidden" name="{{ redirect_field_name }}" value="{{ redirect_field_value }}"/>
        {% endif %}
        <button class="btn text-white" type="submit">Sign Out</button>
    </form>
  </li>
{% endblock %}

{% block dropdown_menu %}
<div class="dropdown-center">
  <buttuon class="d-flex align-items-center text-white dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
    <i class="fa-solid fa-user me-2"></i>
    {{user.username}}
  </button>
  <ul class=" dropdown-menu dropdown-menu-dark">
    <li class="dropdown-item">
      <form class="d-flex justify-content-center mb-2 logout" method="post" action="{% url 'account_logout' %}" aria-current="page">
          {% csrf_token %}
          {% if redirect_field_value %}
              <input type="hidden" name="{{ redirect_field_name }}" value="{{ redirect_field_value }}"/>
          {% endif %}
          <button class="btn text-white" type="submit">Sign Out</button>
      </form>
    </li>
  </ul>
</div>
{% endblock %}

{% block main %}
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-6">
        <div id='calendar'></div>
      </div>
      {% if calendars %}
        <div class="col-md-3">
          <h2>予定リスト</h2>
          {% for event in eventsobj %}
            <div id="event" class="border">
              <div>期間:{{event.start}} ~ {{event.end}}</div>
              <div>イベント名:{{ event.title }}</div>
              <!-- 書き込み権限がある場合のみ編集ボタンを表示 -->
              {% if write %}
                <button type="button" id="edit_{{event.id}}" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop" >
                  編集
                </button>
              {% endif %}
            </div>
          {% endfor %}
        </div>
        <div class="col-md-3">
            <h2>チャット</h2>
              {# TODO:メッセージの投稿を表示 #}
              {# TODO:contextprocessorを使って、ユーザーのアクセス権をコンテキストに与え、↓をif文で表示・非表示 ? #}
              <form action="{% url 'schedule:calendar_message' calendar.id %}" method="POST">
                  {% csrf_token %}
                  <textarea class="form-control" name="content"></textarea>
                  <input class="form-control" type="submit" value="投稿">
              </form>
            
              {% for message in calendar_messages %}
              <div class="border">
                  <div>{{ message.user }} : {{ message.dt }}</div>
                  <div>{{ message.content|linebreaksbr }}</div>
              </div>
              {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>
  <!--モーダルダイアログの記述-->
  <!-- Button trigger modal -->
  <!-- 書き込み権限がある場合modalを表示する -->
  {% if write %}
  <button type="button" id="register" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop" style="display:none">
  </button>
  <div class="modal" id="staticBackdrop" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">イベント編集画面</h5>
          <!-- modal終了のボタン -->
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form action="" name="event_edit" method="post" id="event_edit">
            {% csrf_token %}
            <input type="hidden" name="calendar" value="{{ calendar.id }}">
            <div>
              <div>
                <label for="content" class="form-label">イベントの内容</label>
                <input type="text" class="form-control" name="title" placeholder="イベントの内容">
              </div>
              <div>
                <label for="startdate" class="form-label">開始日：</label>
                <input type="text" name="start" readonly> 
                <label for="enddate" class="form-label">終了日：</label>
                <input type="text" name="end" readonly> 
              </div>
              <a data-bs-toggle="collapse" href="#repeat">繰り返し設定</a>
              <div id="repeat" class="collapse">
                <label for="repeat" class="form-label">繰り返し期間：</label>
                <input type="text" name="repeat" placeholder="日">
                <label for="stop" class="form-label">繰り返し終了日時：</label>
                <input type="text" name="stop" readonly>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
               <button type="submit" class="btn btn-primary" form="event_edit">保存</button>
               <form action="" name="delete_event" method="post">
                {% csrf_token %}
                <input type="submit" value="削除">
               </form>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  {% include "schedule/permission_form.html" %}
{% endblock %}